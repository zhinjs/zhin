# äº‹ä»¶å†’æ³¡é—®é¢˜ä¿®å¤æ€»ç»“

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šåœ¨ reload è¿‡ç¨‹ä¸­ï¼Œäº‹ä»¶å†’æ³¡å­˜åœ¨é—®é¢˜ï¼š
1. **é‡è½½æ—¶ `before-stop` äº‹ä»¶æ²¡æœ‰å†’æ³¡åˆ°æ ¹èŠ‚ç‚¹**
2. **æ–°å¢èŠ‚ç‚¹çš„ `started` äº‹ä»¶æ²¡æœ‰å†’æ³¡åˆ°æ ¹èŠ‚ç‚¹**

## ğŸ” æ ¹æœ¬åŸå› 

é€šè¿‡è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—åˆ†æï¼Œå‘ç°é—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ï¼š

**åœ¨æ ¹èŠ‚ç‚¹ `reload()` æ—¶ï¼Œ`#reloadNode()` æ–¹æ³•ä¸­è°ƒç”¨äº† `this.removeAllListeners()`ï¼Œæ¸…ç©ºäº†æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼ŒåŒ…æ‹¬ç”¨æˆ·æ³¨å†Œçš„ç›‘å¬å™¨ï¼**

### é—®é¢˜æµç¨‹

```typescript
async #reloadNode(isRoot: boolean) {
  if (isRoot) {
    this.started = false;
    this.removeAllListeners();  // âŒ æ¸…ç©ºæ‰€æœ‰ç›‘å¬å™¨
    this.children = [];
    await this.start();
    return this;
  }
  // ...
}
```

å½“æ ¹èŠ‚ç‚¹ reload æ—¶ï¼š
1. `removeAllListeners()` æ¸…ç©ºäº†æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
2. é‡æ–°å¯¼å…¥æ¨¡å—å¹¶ start
3. å­ä¾èµ–è¢«ç§»é™¤æ—¶è§¦å‘ `before-stop` äº‹ä»¶
4. äº‹ä»¶å†’æ³¡åˆ°æ ¹èŠ‚ç‚¹å¹¶è°ƒç”¨ `broadcastAsync()`
5. `broadcastAsync()` è°ƒç”¨ `emitAsync()` å°è¯•è§¦å‘ç›‘å¬å™¨
6. âŒ **ä½†ç›‘å¬å™¨å·²ç»è¢«æ¸…ç©ºäº†ï¼Œæ‰€ä»¥ä»€ä¹ˆä¹Ÿæ²¡å‘ç”Ÿï¼**

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1ï¼šç§»é™¤ `removeAllListeners()` è°ƒç”¨

**ä½ç½®**ï¼š`src/dependency.ts #reloadNode()`

```typescript
async #reloadNode(isRoot: boolean): Promise<Dependency<P>> {
  if (isRoot) {
    // æ ¹èŠ‚ç‚¹ï¼šåŸåœ°é‡å¯
    this.started = false;
    // âŒ ç§»é™¤è¿™è¡Œï¼ä¼šæ¸…ç©ºç”¨æˆ·æ³¨å†Œçš„ç›‘å¬å™¨
    // this.removeAllListeners();
    this.children = [];
    await this.start();
    return this;
  } else {
    // ...
  }
}
```

**åŸå› **ï¼š
- æ ¹èŠ‚ç‚¹ reload æ˜¯åŸåœ°é‡å¯ï¼Œä¿æŒå¼•ç”¨ä¸å˜
- ç”¨æˆ·å¯èƒ½åœ¨æ ¹èŠ‚ç‚¹ä¸Šæ³¨å†Œäº†ç›‘å¬å™¨æ¥ç›‘å¬æ•´ä¸ªä¾èµ–æ ‘çš„äº‹ä»¶
- æ¸…ç©ºç›‘å¬å™¨ä¼šå¯¼è‡´ç”¨æˆ·çš„ç›‘å¬å™¨å¤±æ•ˆ

### ä¿®å¤ 2ï¼šç¡®ä¿ `broadcastAsync` ä¸­ await `emitAsync`

**ä½ç½®**ï¼š`src/dependency.ts broadcastAsync()`

```typescript
// ä¿®å¤å‰
async broadcastAsync(event: string, ...args: any[]): Promise<void> {
  this.emitAsync(event, ...args);  // âŒ æ²¡æœ‰ await
  for (const child of this.children) {
    await child.broadcastAsync(event, ...args);
  }
}

// ä¿®å¤å
async broadcastAsync(event: string, ...args: any[]): Promise<void> {
  await this.emitAsync(event, ...args);  // âœ… æ·»åŠ  await
  for (const child of this.children) {
    await child.broadcastAsync(event, ...args);
  }
}
```

**åŸå› **ï¼š
- æ²¡æœ‰ await ä¼šå¯¼è‡´äº‹ä»¶ç›‘å¬å™¨çš„æ‰§è¡Œé¡ºåºä¸ç¡®å®š
- çˆ¶èŠ‚ç‚¹çš„ç›‘å¬å™¨å¯èƒ½åœ¨å­èŠ‚ç‚¹ä¹‹åæ‰§è¡Œ
- å¦‚æœç›‘å¬å™¨ä¸­æœ‰é”™è¯¯ï¼Œå¯èƒ½æ— æ³•æ­£ç¡®æ•è·

### ä¿®å¤ 3ï¼šç¡®ä¿ `started` äº‹ä»¶ä½¿ç”¨ `dispatchAsync`

**ä½ç½®**ï¼š`src/dependency.ts start()`

```typescript
// ä¿®å¤å‰
await this.mount();
this.dispatch('started', this);  // âŒ åŒæ­¥ dispatch

// ä¿®å¤å
await this.mount();
await this.dispatchAsync('started', this);  // âœ… å¼‚æ­¥ dispatch
```

**åŸå› **ï¼š
- `dispatch()` æ˜¯åŒæ­¥çš„ï¼Œä¸ç­‰å¾…äº‹ä»¶å¤„ç†å®Œæˆ
- `dispatchAsync()` æ˜¯å¼‚æ­¥çš„ï¼Œç¡®ä¿äº‹ä»¶æ­£ç¡®å†’æ³¡å¹¶ç­‰å¾…å¤„ç†å®Œæˆ

## ğŸ“Š ä¿®å¤æ•ˆæœ

### æµ‹è¯•ç»“æœ

è¿è¡Œ `pnpm run test:events` æµ‹è¯•äº‹ä»¶å†’æ³¡ï¼š

```
âœ… æµ‹è¯• 1: started äº‹ä»¶å†’æ³¡
âœ… æµ‹è¯• 2: before-stop äº‹ä»¶å†’æ³¡  
âœ… æµ‹è¯• 3: started äº‹ä»¶å†’æ³¡ï¼ˆæ–°å¢ï¼‰

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼äº‹ä»¶å†’æ³¡æ­£å¸¸å·¥ä½œï¼
```

### ä¿®å¤å‰åå¯¹æ¯”

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| å¯åŠ¨æ—¶ started äº‹ä»¶ | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ |
| Reload æ—¶ before-stop äº‹ä»¶ | âŒ ä¸å†’æ³¡ | âœ… æ­£å¸¸å†’æ³¡ |
| Reload æ—¶ started äº‹ä»¶ï¼ˆæ–°å¢èŠ‚ç‚¹ï¼‰ | âŒ ä¸å†’æ³¡ | âœ… æ­£å¸¸å†’æ³¡ |
| åœæ­¢æ—¶ stopped äº‹ä»¶ | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ |

## ğŸ” è°ƒè¯•è¿‡ç¨‹

### 1. æ·»åŠ è°ƒè¯•æ—¥å¿—

åœ¨å…³é”®ä½ç½®æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼š
- `dispatchAsync()` - è¿½è¸ªäº‹ä»¶å†’æ³¡è·¯å¾„
- `broadcastAsync()` - è¿½è¸ªäº‹ä»¶å¹¿æ’­
- `emitAsync()` - è¿½è¸ªç›‘å¬å™¨æ‰§è¡Œ
- `#diffChildren()` - è¿½è¸ªå­ä¾èµ–å¯¹æ¯”
- `#removeChildren()` - è¿½è¸ªå­ä¾èµ–ç§»é™¤
- `#addChildren()` - è¿½è¸ªå­ä¾èµ–æ·»åŠ 

### 2. åˆ†ææ—¥å¿—

å‘ç°å…³é”®çº¿ç´¢ï¼š
```
[DEBUG emitAsync] hot-reload-plugin emit äº‹ä»¶ before-stop from child-plugin, listeners: 1
```

è¯´æ˜ï¼š
- äº‹ä»¶ç¡®å®åˆ°è¾¾äº†æ ¹èŠ‚ç‚¹
- `broadcastAsync()` è¢«è°ƒç”¨
- `emitAsync()` è¢«è°ƒç”¨
- **ä½†æ²¡æœ‰çœ‹åˆ° `[ROOT æ”¶åˆ° before-stop]`**

### 3. å®šä½æ ¹æœ¬åŸå› 

ç»§ç»­åˆ†æå‘ç°ï¼š
- æµ‹è¯• 1ï¼ˆå¯åŠ¨ï¼‰æ—¶ï¼Œ`listeners: 1` å¹¶ä¸” `[ROOT æ”¶åˆ°]` è¢«æ‰“å°
- æµ‹è¯• 2ï¼ˆreloadï¼‰æ—¶ï¼Œ`listeners: 1` ä½† `[ROOT æ”¶åˆ°]` æ²¡æœ‰è¢«æ‰“å°

å·®å¼‚åœ¨äºæµ‹è¯• 2 ä¹‹å‰æ‰§è¡Œäº† `reload()`ï¼Œè€Œ `reload()` ä¸­è°ƒç”¨äº† `removeAllListeners()`ï¼

### 4. éªŒè¯ä¿®å¤

ç§»é™¤ `removeAllListeners()` åï¼Œæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼

## ğŸ’¡ è®¾è®¡å¯ç¤º

### 1. æ…ç”¨ `removeAllListeners()`

- `removeAllListeners()` ä¼šæ¸…ç©º**æ‰€æœ‰**ç›‘å¬å™¨ï¼ŒåŒ…æ‹¬ç”¨æˆ·æ³¨å†Œçš„
- åœ¨ä¿æŒå¼•ç”¨ä¸å˜çš„çƒ­é‡è½½åœºæ™¯ä¸­ï¼Œä¸åº”è¯¥æ¸…ç©ºç”¨æˆ·çš„ç›‘å¬å™¨
- å¦‚æœéœ€è¦æ¸…ç†å†…éƒ¨ç›‘å¬å™¨ï¼Œåº”è¯¥åªæ¸…ç†ç‰¹å®šçš„äº‹ä»¶æˆ–ä½¿ç”¨å‘½åç©ºé—´

### 2. ä¸€è‡´ä½¿ç”¨ async äº‹ä»¶ç³»ç»Ÿ

- æ‰€æœ‰ç”Ÿå‘½å‘¨æœŸäº‹ä»¶éƒ½åº”è¯¥ä½¿ç”¨ `dispatchAsync` / `broadcastAsync`
- ç¡®ä¿åœ¨ `broadcastAsync` ä¸­ await `emitAsync()`
- ä¿è¯äº‹ä»¶å¤„ç†çš„é¡ºåºæ€§å’Œå®Œæ•´æ€§

### 3. çƒ­é‡è½½çš„å¼•ç”¨ç®¡ç†

**æ ¹èŠ‚ç‚¹çƒ­é‡è½½**ï¼š
- åŸåœ°é‡å¯ï¼Œè¿”å› `this`
- ä¿æŒå¤–éƒ¨å¼•ç”¨ä¸å˜
- ä¸æ¸…ç©ºç”¨æˆ·ç›‘å¬å™¨

**å­èŠ‚ç‚¹çƒ­é‡è½½**ï¼š
- åˆ›å»ºæ–°å®ä¾‹
- é€šè¿‡çˆ¶èŠ‚ç‚¹çš„ `importChild()` åˆ›å»º
- æ›¿æ¢çˆ¶èŠ‚ç‚¹ children æ•°ç»„ä¸­çš„æ—§å®ä¾‹

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [DEBUG-EVENTS.md](./DEBUG-EVENTS.md) - äº‹ä»¶å†’æ³¡è°ƒè¯•æŒ‡å—
- [LIFECYCLE-CHANGES.md](./LIFECYCLE-CHANGES.md) - ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å˜æ›´
- [REFACTOR-RELOAD.md](./REFACTOR-RELOAD.md) - reload æ–¹æ³•é‡æ„è¯´æ˜

## ğŸ“ ç»éªŒæ€»ç»“

1. **é—®é¢˜å®šä½**ï¼šé€šè¿‡è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—é€å±‚è¿½è¸ªï¼Œæœ€ç»ˆå®šä½åˆ° `removeAllListeners()`
2. **æµ‹è¯•é©±åŠ¨**ï¼šç¼–å†™ä¸“é—¨çš„æµ‹è¯•ç”¨ä¾‹æ¥éªŒè¯äº‹ä»¶å†’æ³¡æœºåˆ¶
3. **ç³»ç»Ÿæ€ç»´**ï¼šäº‹ä»¶ç³»ç»Ÿéœ€è¦ä»å‘é€ç«¯ã€ä¼ è¾“ç«¯ã€æ¥æ”¶ç«¯å…¨é“¾è·¯è€ƒè™‘
4. **å‘åå…¼å®¹**ï¼šä¿®å¤ä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼Œæ‰€æœ‰æµ‹è¯•é€šè¿‡

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2025-01-XX
**ä¿®å¤å½±å“**ï¼šâœ… äº‹ä»¶å†’æ³¡æœºåˆ¶å®Œå…¨æ­£å¸¸å·¥ä½œ
**æµ‹è¯•è¦†ç›–**ï¼šâœ… 100% æµ‹è¯•ç”¨ä¾‹é€šè¿‡

