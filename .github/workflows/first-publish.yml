name: First Publish (for new packages)

# ç”¨äºé¦–æ¬¡å‘å¸ƒä»æœªå‘å¸ƒè¿‡çš„åŒ…
# ä½¿ç”¨ä¼ ç»Ÿ NPM_TOKENï¼Œå‘å¸ƒåç«‹å³é…ç½®å¯ä¿¡å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      package_name:
        description: 'è¦å‘å¸ƒçš„åŒ…åï¼ˆå¦‚ï¼š@zhin.js/adapter-sandboxï¼‰'
        required: true
        type: string
      package_path:
        description: 'åŒ…çš„è·¯å¾„ï¼ˆå¦‚ï¼šplugins/adapters/sandboxï¼‰'
        required: true
        type: string

permissions:
  contents: read

jobs:
  first-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.2

      - name: Setup Node.js with npm registry
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build package
        run: cd ${{ inputs.package_path }} && pnpm build

      - name: Publish package (first time)
        run: cd ${{ inputs.package_path }} && npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Post-publish instructions
        run: |
          echo "âœ… åŒ… ${{ inputs.package_name }} é¦–æ¬¡å‘å¸ƒæˆåŠŸï¼"
          echo ""
          echo "ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œï¼š"
          echo "1. è®¿é—®ï¼šhttps://www.npmjs.com/package/${{ inputs.package_name }}/access"
          echo "2. é…ç½®å¯ä¿¡å‘å¸ƒè€…ï¼š"
          echo "   - Provider: GitHub Actions"
          echo "   - Repository: zhinjs/zhin"
          echo "   - Workflow: publish.yml"
          echo "3. åç»­å‘å¸ƒå°†è‡ªåŠ¨ä½¿ç”¨å¯ä¿¡å‘å¸ƒï¼ˆæ— éœ€ NPM_TOKENï¼‰"
          echo ""
          echo "ğŸ”’ å»ºè®®ï¼š"
          echo "- é…ç½®å®Œæˆåï¼Œå¯ç”¨ 'Require 2FA and disallow tokens'"
          echo "- è¿™æ ·å¯ä»¥å¼ºåˆ¶ä½¿ç”¨å¯ä¿¡å‘å¸ƒï¼Œæé«˜å®‰å…¨æ€§"

