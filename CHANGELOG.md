# Changelog

## [2.0.0] - 2024-12-26

### ğŸ‰ é‡å¤§æ¶æ„å‡çº§

Zhin.js 2.0 æ˜¯ä¸€æ¬¡é‡å¤§æ¶æ„é‡æ„ï¼Œç§»é™¤äº† HMR ä¾èµ–ï¼Œç®€åŒ–äº†æ’ä»¶ç³»ç»Ÿï¼Œæå‡äº†æ€§èƒ½å’Œç¨³å®šæ€§ã€‚

### âœ¨ æ–°å¢åŠŸèƒ½

#### æ ¸å¿ƒæ¶æ„
- **ç§»é™¤ `@zhin.js/hmr` ä¾èµ–**ï¼šä½¿ç”¨ Node.js åŸç”Ÿæ¨¡å—ç³»ç»Ÿï¼Œæ›´ç¨³å®šå¯é 
- **ç®€åŒ–çš„æ’ä»¶ç³»ç»Ÿ**ï¼šåŸºäº `AsyncLocalStorage` çš„ä¸Šä¸‹æ–‡ç®¡ç†
- **å†…ç½®æœåŠ¡ç³»ç»Ÿ**ï¼šcommandã€componentã€cronã€permissionã€configã€database ä½œä¸ºå†…ç½®æœåŠ¡
- **è‡ªåŠ¨èµ„æºæ¸…ç†**ï¼šæ’ä»¶å¸è½½æ—¶è‡ªåŠ¨æ¸…ç†æ³¨å†Œçš„å‘½ä»¤ã€ç»„ä»¶ã€å®šæ—¶ä»»åŠ¡ç­‰èµ„æº
- **æ’ä»¶åŠŸèƒ½è¿½è¸ª**ï¼š`plugin.features` å±æ€§è®°å½•æ’ä»¶æä¾›çš„åŠŸèƒ½
- **`usePlugin()` API**ï¼šæ›¿ä»£ `useApp()`ï¼Œè·å–å½“å‰æ’ä»¶å®ä¾‹
- **`useContext()` API**ï¼šç­‰å¾…å¹¶ä½¿ç”¨ç‰¹å®šæœåŠ¡
- **`provide()` API**ï¼šæä¾›æœåŠ¡ç»™å…¶ä»–æ’ä»¶
- **`onDispose()` API**ï¼šæ³¨å†Œæ’ä»¶å¸è½½æ—¶çš„æ¸…ç†å‡½æ•°

#### æ•°æ®åº“æ¨¡å—
- **äº‹åŠ¡æ”¯æŒ**ï¼šå®Œæ•´çš„äº‹åŠ¡ APIï¼Œæ”¯æŒåµŒå¥—äº‹åŠ¡å’Œä¿å­˜ç‚¹
- **è¿ç§»ç³»ç»Ÿ**ï¼šè‡ªåŠ¨ç”Ÿæˆ `down` è¿ç§»é€»è¾‘ï¼Œæ”¯æŒç‰ˆæœ¬ç®¡ç†
- **ç”Ÿå‘½å‘¨æœŸé’©å­**ï¼šbeforeCreateã€afterCreateã€beforeUpdateã€afterUpdateã€beforeDeleteã€afterDelete
- **å¤šå¯¹å¤šå…³ç³»**ï¼š`belongsToMany` å…³ç³»å®šä¹‰å’ŒåŠ è½½ï¼Œæ”¯æŒ pivot æ•°æ®
- **å¢å¼ºçš„æŸ¥è¯¢æ„å»ºå™¨**ï¼šæ”¯æŒæ›´å¤æ‚çš„æŸ¥è¯¢æ¡ä»¶å’Œèšåˆå‡½æ•°
- **`defineModel` æ‰©å±•**ï¼šåœ¨æ’ä»¶ä¸­ç›´æ¥è°ƒç”¨ `plugin.defineModel()` å®šä¹‰æ¨¡å‹

#### é…ç½®ç³»ç»Ÿ
- **YAML é…ç½®æ ¼å¼**ï¼šä» `.ts` è¿ç§»åˆ° `.yml`ï¼Œæ›´ç®€æ´æ˜“è¯»
- **ç¯å¢ƒå˜é‡æ”¯æŒ**ï¼šæ”¯æŒ `.env` å’Œ `.env.{mode}` æ–‡ä»¶
- **é…ç½®çƒ­é‡è½½**ï¼šé…ç½®æ–‡ä»¶å˜æ›´æ—¶è‡ªåŠ¨é‡è½½ç›¸å…³æ’ä»¶

#### å¼€å‘ä½“éªŒ
- **æ”¹è¿›çš„æ—¥å¿—ç³»ç»Ÿ**ï¼šåŒºåˆ† root/setup æ’ä»¶å’Œæ™®é€šæ’ä»¶çš„æ—¥å¿—çº§åˆ«
- **æ›´å¥½çš„ç±»å‹æ¨å¯¼**ï¼šå®Œæ•´çš„ TypeScript ç±»å‹æ”¯æŒ
- **çƒ­é‡è½½ä¼˜åŒ–**ï¼šä½¿ç”¨ Node.js åŸç”Ÿæ¨¡å—ç³»ç»Ÿï¼Œæ›´ç¨³å®šå¯é 

#### Console æ’ä»¶ä¼˜åŒ–
- **æŒ‰éœ€åŠ è½½ Vite**ï¼šå¼€å‘æ¨¡å¼ä¸‹å¯é€‰æ‹©å»¶è¿ŸåŠ è½½ Viteï¼ŒèŠ‚çœå†…å­˜
- **åŠ¨æ€å¯¼å…¥ä¼˜åŒ–**ï¼šVite å’Œ React ç›¸å…³ä¾èµ–ä½¿ç”¨åŠ¨æ€å¯¼å…¥ï¼Œå‡å°‘åˆå§‹å†…å­˜å ç”¨
- **ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–**ï¼šç”Ÿäº§ç¯å¢ƒåªä¾èµ– `mime` å’Œ `ws`ï¼Œç£ç›˜å ç”¨å‡å°‘ 98%
- **ä¾èµ–åˆ†ç±»**ï¼šæ­£ç¡®åŒºåˆ† `dependencies`ã€`devDependencies` å’Œ `optionalDependencies`

### ğŸ”„ å˜æ›´

#### ç ´åæ€§å˜æ›´

**API å˜æ›´**ï¼š
- `useApp()` â†’ `usePlugin()` - è·å–å½“å‰æ’ä»¶å®ä¾‹
- `defineModel()` â†’ `plugin.defineModel()` - å®šä¹‰æ•°æ®æ¨¡å‹
- `onDatabaseReady()` â†’ `useContext('database')` - ç­‰å¾…æ•°æ®åº“å°±ç»ª

**é…ç½®æ–‡ä»¶**ï¼š
- `zhin.config.ts` â†’ `zhin.config.yml`
- `defineConfig()` å‡½æ•°ä¸å†éœ€è¦

**æ’ä»¶ç³»ç»Ÿ**ï¼š
- ç§»é™¤ `App` ç±»çš„ç›´æ¥è®¿é—®
- æ’ä»¶é—´é€šä¿¡æ”¹ç”¨ `provide()` å’Œ `useContext()`
- èµ„æºè‡ªåŠ¨æ¸…ç†ï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†

**é€‚é…å™¨**ï¼š
- `@zhin.js/adapter-process` é‡å‘½åä¸º `@zhin.js/adapter-sandbox`

**ä¾èµ–åŒ…**ï¼š
- ç§»é™¤ `@zhin.js/hmr` åŒ…
- ç§»é™¤ `@zhin.js/types` åŒ…ï¼ˆç±»å‹å®šä¹‰åˆå¹¶åˆ° `@zhin.js/core`ï¼‰

### ğŸ› ä¿®å¤

- **å†…å­˜æ³„æ¼ä¿®å¤**ï¼š
  - ä¿®å¤ `evalCache` æ— é™å¢é•¿é—®é¢˜ï¼Œå®ç° LRU ç¼“å­˜ï¼ˆæœ€å¤§ 1000 æ¡ï¼‰
  - ä¿®å¤æ’ä»¶å¸è½½æ—¶æœªæ¸…ç† `loadedModules` çš„é—®é¢˜
  - ä¿®å¤ `DatabaseLogTransport` é‡å¤æ·»åŠ çš„é—®é¢˜
  - ä¿®å¤äº‹ä»¶ç›‘å¬å™¨æœªæ¸…ç†çš„é—®é¢˜

- **æ—¥å¿—ç³»ç»Ÿä¿®å¤**ï¼š
  - ä¿®å¤é‡å¤æ—¥å¿—è¾“å‡ºé—®é¢˜
  - ä¼˜åŒ–æ—¥å¿—çº§åˆ«ï¼Œå‡å°‘ä¸å¿…è¦çš„æ—¥å¿—

- **HTTP æœåŠ¡ä¿®å¤**ï¼š
  - ä¿®å¤ `server.listen` åœ¨ macOS ä¸Šçš„ EPERM é”™è¯¯ï¼ˆæ”¹ä¸ºç›‘å¬ `127.0.0.1` è€Œé `0.0.0.0`ï¼‰
  - ä¿®å¤ `/api/stats` æ¥å£çš„ç±»å‹é”™è¯¯

- **ç±»å‹é”™è¯¯ä¿®å¤**ï¼š
  - ä¿®å¤ `CronService` ç±»å‹å£°æ˜
  - ä¿®å¤ `Plugin.Contexts` ç±»å‹å®šä¹‰
  - ä¿®å¤æ•°æ®åº“ç›¸å…³ç±»å‹é”™è¯¯

### ğŸ“ æ–‡æ¡£

- æ–°å¢å®Œæ•´çš„æ¶æ„æ–‡æ¡£
- æ–°å¢æ•°æ®åº“åŠŸèƒ½æ–‡æ¡£
- æ–°å¢ Console æ’ä»¶ä¼˜åŒ–æ–‡æ¡£
- æ–°å¢å†…å­˜åˆ†ææŒ‡å—
- æ›´æ–°æ‰€æœ‰ API æ–‡æ¡£

### ğŸ§ª æµ‹è¯•

- æ–°å¢æ•°æ®åº“æ¨¡å—å®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ˆ1738 è¡Œï¼Œ81 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- æ–°å¢è¿ç§»ç³»ç»Ÿæµ‹è¯•
- æ–°å¢ç”Ÿå‘½å‘¨æœŸé’©å­æµ‹è¯•
- æ–°å¢å¤šå¯¹å¤šå…³ç³»æµ‹è¯•

### ğŸš€ æ€§èƒ½ä¼˜åŒ–

- **å¯åŠ¨æ€§èƒ½**ï¼š
  - Console æ’ä»¶å¯åŠ¨å†…å­˜ä» 42MB é™è‡³ 17MBï¼ˆå»¶è¿ŸåŠ è½½æ¨¡å¼ï¼‰
  - æ’ä»¶åŠ è½½é€Ÿåº¦æå‡ 30%

- **è¿è¡Œæ—¶æ€§èƒ½**ï¼š
  - `evalCache` ä½¿ç”¨ LRU ç¼“å­˜ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
  - ä¼˜åŒ–æ’ä»¶ä¸Šä¸‹æ–‡ç®¡ç†ï¼Œå‡å°‘å†…å­˜å ç”¨
  - è‡ªåŠ¨èµ„æºæ¸…ç†ï¼Œé¿å…å†…å­˜æ³„æ¼

- **æ„å»ºæ€§èƒ½**ï¼š
  - Console æ’ä»¶ç”Ÿäº§ç¯å¢ƒç£ç›˜å ç”¨ä» 200MB é™è‡³ 2MBï¼ˆ98% å‡å°‘ï¼‰

### âš ï¸ å·²çŸ¥é—®é¢˜

- Console æ’ä»¶åœ¨æµè§ˆå™¨é¦–æ¬¡è®¿é—®æ—¶ï¼ŒVite æ¨¡å—ç¼“å­˜ä¼šå¢åŠ çº¦ 20MB å†…å­˜ï¼ˆæ­£å¸¸ç°è±¡ï¼‰
- Discord é€‚é…å™¨ä¼šå¢åŠ çº¦ 20MB å†…å­˜ï¼ˆdiscord.js åº“æœ¬èº«è¾ƒå¤§ï¼‰

---

## å‡çº§æŒ‡å—

### å¿«é€Ÿå‡çº§æ­¥éª¤

1. **æ›´æ–°ä¾èµ–**
```bash
pnpm update zhin.js @zhin.js/core
```

2. **è½¬æ¢é…ç½®æ–‡ä»¶**

åˆ é™¤ `zhin.config.ts`ï¼Œåˆ›å»º `zhin.config.yml`ï¼š

```yaml
log_level: 1
database:
  dialect: sqlite
  filename: ./data/bot.db
plugin_dirs:
  - node_modules
  - ./src/plugins
plugins:
  - your-plugin
```

3. **æ›´æ–°æ’ä»¶ä»£ç **

```typescript
// æ—§ç‰ˆæœ¬
import { useApp, addCommand, MessageCommand, defineModel, onDatabaseReady } from 'zhin.js';
const app = useApp();

defineModel('users', { /* ... */ });

onDatabaseReady((db) => {
  // ...
});

addCommand(
  new MessageCommand('hello')
    .action((message) => {
      return 'Hello!';
    })
);

// æ–°ç‰ˆæœ¬
import { usePlugin, MessageCommand } from 'zhin.js';

const plugin = usePlugin();
const { addCommand, useContext } = plugin;

// å®šä¹‰æ¨¡å‹
plugin.defineModel('users', { /* ... */ });

// ç­‰å¾…æ•°æ®åº“å°±ç»ª
useContext('database', (db) => {
  // ...
});

// æ·»åŠ å‘½ä»¤
addCommand(
  new MessageCommand('hello')
    .action((message) => {
      return 'Hello!';
    })
);
```

### ä¸»è¦ API å¯¹ç…§

| æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ |
|--------|--------|
| `useApp()` | `usePlugin()` |
| `defineModel(name, def)` | `plugin.defineModel(name, def)` |
| `onDatabaseReady(fn)` | `useContext('database', fn)` |
| `app.database` | `plugin.root.inject('database')` |
| `app.config` | `plugin.config` |

### è¯¦ç»†ä¿¡æ¯

æ›´å¤šå‡çº§ç»†èŠ‚è¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£å’Œç¤ºä¾‹ä»£ç ã€‚

---

## è·å–å¸®åŠ©

- ğŸ“– æŸ¥çœ‹ [examples/test-bot](./examples/test-bot) äº†è§£æ–°ç‰ˆæœ¬ç”¨æ³•
- ğŸ› [æäº¤ Issue](https://github.com/zhinjs/zhin/issues)
